<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FChess Game</title>
    <link rel="stylesheet" href="./asset/base.css">
    <link rel="stylesheet" href="./asset/brown.css">
    <link rel="stylesheet" href="./asset/cburnett.css">
    <style>
        /* Reset & Tampilan Dasar */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c2f33; /* Latar belakang gelap untuk kontras */
            color: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Kontainer Utama (Berlaku untuk Lobby, Game, dll) */
        .game-container {
            width: 90%;
            max-width: 550px;
            margin: 0 auto;
            background-color: #36393f; /* Warna kontainer yang sedikit lebih terang */
            border-radius: 12px;
            padding: 25px 35px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid #4f545c;
        }

        /* PERBAIKAN: Perlebar kontainer khusus untuk tampilan game */
        #gameUIContainer {
            max-width: 850px;
        }


        /* Header Lobi */
        .lobby-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #4f545c;
            padding-bottom: 20px;
        }

            .lobby-header h1 {
                color: #fff;
                margin: 0;
            }

            .lobby-header p {
                color: #b9bbbe;
                font-size: 1em;
            }

        /* Bagian Lobi (Create, Join) */
        .lobby-section {
            background-color: #40444b; /* Warna kartu di dalam lobi */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

            .lobby-section h3 {
                margin-top: 0;
                color: #fff;
                border-bottom: 1px solid #4f545c;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

        /* Styling Form */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

            .form-group label {
                margin-bottom: 8px;
                font-weight: bold;
                color: #b9bbbe;
            }

        .form-group-inline {
            display: flex;
            gap: 10px;
        }

        select, input[type="text"] {
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #2c2f33;
            background-color: #303338;
            color: #ddd;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }

            select:focus, input[type="text"]:focus {
                outline: none;
                border-color: #7289da; /* Aksen warna Discord */
            }

        /* Styling Tombol */
        .btn {
            padding: 12px 20px;
            margin: 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: white;
            transition: all 0.2s ease;
        }

            .btn:hover:not(:disabled) {
                opacity: 0.9;
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            }

            .btn:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
            }

        .btn-success {
            background-color: #43b581;
        }
        /* Aksen warna hijau Discord */
        .btn-large {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
        }

        .btn-text { /* Untuk tombol yang tidak terlalu penting */
            background: none;
            color: #7289da;
            font-size: 0.9em;
            cursor: pointer;
        }

        /* Daftar Game yang Tersedia */
        #gameList {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .game-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #36393f;
            border-radius: 5px;
            border: 1px solid #4f545c;
        }

        .game-info span {
            font-weight: bold;
            color: #fff;
        }

        .no-games-message {
            color: #b9bbbe;
            text-align: center;
            padding: 20px 0;
        }

        /* Footer Lobi */
        .lobby-footer {
            text-align: center;
            margin-top: 10px;
        }

        /* Styling untuk UI Game (Agar tetap konsisten) */
        #gameUIContainer h1, #waitingRoom h2 {
            color: #fff;
        }

        #status, #playerDisplay {
            background-color: #40444b;
            color: #b9bbbe;
            border: 1px solid #4f545c;
        }

        /* Styling untuk gameOverOverlay */
        #gameOverOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 99999;
            justify-content: center;
            align-items: center;
        }

        #gameOverContent {
            background-color: #36393f;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            color: #fff;
            border: 1px solid #4f545c;
        }
        /* Tambahkan atau perbarui aturan CSS ini */

        .btn-danger {
            background-color: #d9534f; /* Warna merah untuk tombol Resign */
        }

            .btn-danger:hover:not(:disabled) {
                background-color: #c9302c;
            }

        .clock-container {
            display: flex;
            justify-content: flex-end; /* Jam akan rata kanan */
            padding: 5px 10px;
        }

        .clock {
            font-size: 1.5em;
            font-weight: bold;
            color: #fff; /* Ubah warna teks jam agar kontras dengan latar belakang baru */
            background-color: #2c2f33; /* Latar belakang untuk jam */
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #4f545c;
        }
        /*untuk klik ke klik*/
        .highlight-square {
            box-shadow: inset 0 0 25px yellow;
        }
        /* Tambahkan di dalam <style> */
        .main-game-area {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .board-column {
            flex-grow: 1;
        }

        .history-column {
            width: 220px; /* Lebar panel riwayat */
            background-color: #40444b;
            padding: 15px;
            border-radius: 8px;
            height: 500px; /* PERBAIKAN: Sesuaikan tinggi agar sejajar dengan papan + jam */
            display: flex;
            flex-direction: column;
        }

        .move-history-list {
            flex-grow: 1;
            overflow-y: auto; /* Aktifkan scroll jika daftar penuh */
            background-color: #303338;
            border-radius: 5px;
            padding: 10px;
            color: #ddd;
        }

        .history-controls {
            display: flex;
            justify-content: space-around;
            padding-top: 15px;
            border-top: 1px solid #4f545c;
        }

            .history-controls .btn {
                padding: 8px 12px;
                font-size: 1.2em;
            }

        .move-pair {
            display: flex;
            margin-bottom: 5px;
        }

        .move-number {
            font-weight: bold;
            width: 30px;
        }

        .move-notation {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
        }

            .move-notation:hover {
                background-color: #7289da;
            }

        /* --- CSS FINAL UNTUK TAMPILAN RESPONSIF --- */
        @media (max-width: 768px) {
            /* 1. Buat Layout Memenuhi Seluruh Layar */
            html, body {
                height: 100%;
                width: 100%;
                overflow: hidden; /* Mencegah scroll yang tidak perlu */
            }

            .game-container, #gameUIContainer {
                width: 100%;
                min-height: 100vh; /* Memenuhi tinggi layar perangkat */
                border-radius: 0; /* Hapus sudut melengkung di mobile */
                padding: 10px;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
            }

                #gameUIContainer h1 {
                    display: none;
                }

            /* 2. Stabilkan Jam dan Status untuk Menghilangkan Goyangan */
            .clock {
                font-size: 1.4em;
                padding: 8px 12px;
                /* KUNCI: Gunakan font monospace agar lebar teks tidak berubah-ubah */
                font-family: 'Courier New', Courier, monospace;
                text-align: center;
                width: 140px; /* Beri lebar tetap */
                box-sizing: border-box;
            }

            .status-container {
                margin-bottom: 5px;
            }

            #status {
                min-height: 2.5em;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 5px;
                font-size: 0.9em;
            }

            /* 3. Atur Ulang Tata Letak Area Game Utama */
            .main-game-area {
                flex-direction: column;
                align-items: center;
                margin: auto 0; /* Ini akan memusatkan papan secara vertikal */
            }

            .board-column, .history-column {
                width: 100%;
            }

            #myBoard {
                width: 100% !important;
                margin: 5px 0 !important;
            }

            .history-column {
                display: none; /* Sembunyikan riwayat di mobile untuk fokus pada papan */
                /* Jika ingin tetap menampilkannya, hapus baris di atas dan gunakan ini:
        margin-top: 15px;
        height: 150px;
        */
            }

            /* 4. Posisikan Tombol di Bawah */
            .controls {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }

                .controls .btn {
                    width: 100%;
                }
        }
        /* --- CSS untuk Dialog Promosi --- */
        #promotionOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 100000;
            justify-content: center;
            align-items: center;
        }

        #promotionDialog {
            background-color: #36393f;
            padding: 20px 30px;
            border-radius: 12px;
            text-align: center;
            color: #fff;
            border: 1px solid #4f545c;
        }

        .promotion-choices {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .promotion-piece {
            cursor: pointer;
            padding: 10px;
            background-color: #40444b;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

            .promotion-piece:hover {
                background-color: #7289da;
            }

            .promotion-piece img {
                width: 60px;
                height: 60px;
            }
    </style>
</head>
<body>
    <div id="lobby" class="game-container">
        <div class="lobby-header">
            <h1>♔ Lobi Catur Silea ♚</h1>
            <p>Create a new game or join an existing one.</p>
        </div>
        <div class="lobby-section create-game-section">
            <h3>Create a New Game</h3>
            <div class="form-group">
                <label for="timeFormat">Time Control:</label>
                <select id="timeFormat">
                    <option value="300000">5 minutes</option>
                    <option value="180000">3 minutes</option>
                    <option value="60000">1 minute (Bullet)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="skillLevel">AI Difficulty:</label>
                <select id="skillLevel">
                    <option value="1">Beginner (Skill 1)</option>
                    <option value="5">Intermediate (Skill 5)</option>
                    <option value="10" selected>Advanced (Skill 10)</option>
                    <option value="15">Expert (Skill 15)</option>
                    <option value="20">Master (Skill 20)</option>
                </select>
            </div>
            <button id="createGameBtn" class="btn btn-success btn-large">Create Human Game</button>
            <button id="playAiBtn" class="btn btn-large" style="background-color: #7289da; margin-top: 10px;">Main lawan stockfish</button>
        </div>
        <div class="lobby-section">
            <h3>Available Games</h3>
            <div id="gameList">
                <p class="no-games-message">No games are currently available. Why not create one?</p>
            </div>
        </div>
        <div class="lobby-section join-id-section">
            <h4>Join with Game ID</h4>
            <div class="form-group-inline">
                <input type="text" id="joinGameId" placeholder="Enter Game ID">
                <button id="joinGameBtn" class="btn" disabled>Join</button>
            </div>
        </div>
        <div class="lobby-footer">
            <button id="clearLocalStorageBtn" class="btn-text">Clear Local Storage</button>
        </div>
    </div>

    <div id="waitingRoom" class="game-container" style="display: none;">
        <h2>Waiting for Opponent</h2>
        <p id="waitingMessage"></p>
    </div>

    <div id="gameUIContainer" class="game-container" style="display: none;">
        <h1>♔ FChess Game ♚</h1>
        <div class="status-container">
            <div id="playerDisplay"><span class="connection-status disconnected"></span>Player: Not connected</div>
            <div id="status" style="margin-top: 10px;">Connecting to server...</div>
        </div>

        <div class="main-game-area">
            <div class="board-column">
                <div id="opponentClockContainer" class="clock-container opponent-clock"></div>
                <div id="myBoard" style="width: 400px; margin: 15px auto;"></div>
                <div id="playerClockContainer" class="clock-container player-clock"></div>
            </div>

            <div class="history-column">
                <h3>Riwayat Gerakan</h3>
                <div id="moveHistory" class="move-history-list">
                </div>
                <div class="history-controls">
                    <button id="rewindBtn" class="btn">⏪</button>
                    <button id="prevBtn" class="btn">◀️</button>
                    <button id="nextBtn" class="btn">▶️</button>
                    <button id="fastForwardBtn" class="btn">⏩</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="resignBtn" class="btn btn-danger">Resign</button>
            <button id="newGameBtn" class="btn btn-success" disabled>New Game</button>
        </div>

        <div id="clockTemplates" style="display: none;">
            <div id="whiteClock" class="clock">White: 05:00</div>
            <div id="blackClock" class="clock">Black: 05:00</div>
        </div>
    </div>

    <div id="gameOverOverlay" style="display: none;">
        <div id="gameOverContent">
            <h2 id="gameOverMessage"></h2>
            <button id="backToLobbyBtn" class="btn btn-success">Back to Lobby</button>
        </div>
    </div>
    <div id="promotionOverlay" style="display: none;">
        <div id="promotionDialog">
            <h3>Pilih Bidak Promosi</h3>
            <div class="promotion-choices">
                <div class="promotion-piece" data-piece="q">
                    <img src="img/chesspieces/wikipedia/wQ.png" alt="Queen">
                </div>
                <div class="promotion-piece" data-piece="r">
                    <img src="img/chesspieces/wikipedia/wR.png" alt="Rook">
                </div>
                <div class="promotion-piece" data-piece="b">
                    <img src="img/chesspieces/wikipedia/wB.png" alt="Bishop">
                </div>
                <div class="promotion-piece" data-piece="n">
                    <img src="img/chesspieces/wikipedia/wN.png" alt="Knight">
                </div>
            </div>
        </div>
    </div>

    <script src="jquery-3.5.1.min.js"></script>
    <script type="module">
        import { Chess } from './asset/chess.mjs';
        import { Chessground } from 'https://unpkg.com/chessground@9.2.1/dist/chessground.min.js';
        // --- Global State ---
        let board = null;
        let game = new Chess();
        let socket;
        let playerColor = null;
        let gameActive = false;
        let myGameId = null;
        let whiteTimeRemaining = 0;
        let blackTimeRemaining = 0;
        let lastUpdateTime = 0;
        let clockInterval = null;
        let stockfish;
        let isAiGame = false;
        let isEngineReady = false; // <-- Tambahkan baris ini
        // Di bawah `let isEngineReady = false;`
        let localMoveHistory = [];
        let selectedSquare = null;
        // Di bagian atas skrip Anda
        let viewingHistory = false; // Untuk menandai apakah kita sedang melihat riwayat
        let historyBoard = new Chess(); // Papan catur virtual untuk menelusuri riwayat
        let selectedSkillLevel = 10; // Nilai default
        // Di bawah `let selectedSkillLevel = 10;`
        let pendingMove = null;
        //       let clickSourceSquare = null;

        const playAiBtn = $('#playAiBtn');

        // --- DOM Elements ---
        const statusEl = $('#status');
        const playerDisplayEl = $('#playerDisplay');
        const resignBtn = $('#resignBtn');
        const newGameBtn = $('#newGameBtn');
        const connectionIndicator = $('.connection-status');
        const whiteClockEl = $('#whiteClock');
        const blackClockEl = $('#blackClock');
        const lobbyEl = $('#lobby');
        const waitingRoomEl = $('#waitingRoom');
        const waitingMessageEl = $('#waitingMessage');
        const gameUIContainer = $('#gameUIContainer');
        const createGameBtn = $('#createGameBtn');
        const joinGameBtn = $('#joinGameBtn'); // Tombol join berdasarkan ID
        const joinGameIdInput = $('#joinGameId');
        const timeFormatSelect = $('#timeFormat');
        const clearLocalStorageBtn = $('#clearLocalStorageBtn');
        const gameOverOverlay = $('#gameOverOverlay');
        const gameOverMessage = $('#gameOverMessage');
        const backToLobbyBtn = $('#backToLobbyBtn');
        // Di bawah `const backToLobbyBtn = ...`
        const opponentClockContainer = $('#opponentClockContainer');
        const playerClockContainer = $('#playerClockContainer');

        // --- UI State Management ---
        function showSection(sectionName) {
            lobbyEl.css('display', 'none');
            waitingRoomEl.css('display', 'none');
            gameUIContainer.css('display', 'none');

            switch (sectionName) {
                case 'lobby':
                    lobbyEl.css('display', 'block');
                    break;
                case 'waitingRoom':
                    waitingRoomEl.css('display', 'block');
                    break;
                case 'game':
                    gameUIContainer.css('display', 'block');
                    setTimeout(function () {
                        board.resize();
                    }, 0);

                    break;
            }
        }

        // GANTI SELURUH FUNGSI initStockfish ANDA DENGAN INI

        function initStockfish(skillLevel) {
            console.log(`Initializing Stockfish with Skill Level: ${skillLevel}`);
            isAiGame = true;
            isEngineReady = false;

            // Hentikan worker lama jika ada sebelum membuat yang baru
            if (stockfish) {
                stockfish.terminate();
            }

            stockfish = new Worker('stockfish-engine.js');

            stockfish.onmessage = (event) => {
                const line = typeof event === 'object' ? event.data : event;
                console.log("Stockfish:", line);

                if (line === 'uciok') {
                    isEngineReady = true;
                    stockfish.postMessage(`setoption name Skill Level value ${skillLevel}`);
                    console.log(`Engine skill level set to: ${skillLevel}`);
                }

                // --- LOGIKA PENTING YANG HILANG ADA DI SINI ---
                if (line.startsWith('bestmove')) {
                    const bestMove = line.split(' ')[1];

                    // Lakukan gerakan dari AI di mesin catur lokal
                    const moveResult = game.move(bestMove, { sloppy: true });

                    // Jika karena alasan tertentu gerakan AI tidak sah, hentikan.
                    if (moveResult === null) {
                        console.error("Stockfish suggested an illegal move:", bestMove);
                        return;
                    }

                    // Perbarui papan visual dengan posisi baru
                    board.set(game.fen());

                    // Kirim gerakan AI ke server agar lawan (jika ada) bisa melihat
                    // dan agar riwayat permainan tercatat dengan benar.
                    const from = moveResult.from;
                    const to = moveResult.to; // <-- HAPUS BLOK PENGIRIMAN gameOver DARI SINI
                    const moveData = { type: 'move', gameId: myGameId, ...algebraicToRowCol(from), ...algebraicToRowCol(to, true) }; // Server akan menangani deteksi game over
                    socket.send(JSON.stringify(moveData)); // Cukup kirim gerakannya saja
                }
            };

            stockfish.postMessage('uci');
        }

        function askStockfishToMove() {
            // ... (kode pengecekan isEngineReady, dll) ...

            stockfish.postMessage('ucinewgame');

            // Baris ini sekarang akan berfungsi dengan benar
            stockfish.postMessage('position startpos moves' + getMovesString());

            stockfish.postMessage('go movetime 1500');
        }

        // GANTI FUNGSI updateMoveHistory LAMA ANDA DENGAN INI
        function updateMoveHistory() {
            const historyList = $('#moveHistory');
            historyList.empty(); // Kosongkan daftar sebelum mengisi ulang

            // Gunakan chess.js HANYA untuk mendapatkan notasi (SAN)
            const tempGame = new Chess();

            for (let i = 0; i < localMoveHistory.length; i += 2) {
                const movePair = $('<div class="move-pair"></div>');
                const moveNumber = $(`<div class="move-number">${(i / 2) + 1}.</div>`);
                movePair.append(moveNumber);

                // Langkah Putih
                if (localMoveHistory[i]) {
                    const from = rowColToAlgebraic(localMoveHistory[i].fromRow, localMoveHistory[i].fromCol);
                    const to = rowColToAlgebraic(localMoveHistory[i].toRow, localMoveHistory[i].toCol);
                    const move = tempGame.move({ from, to, promotion: 'q' });

                    const whiteMove = $(`<div class="move-notation">${move.san}</div>`);
                    whiteMove.on('click', () => viewHistoryMove(i));
                    movePair.append(whiteMove);
                }

                // Langkah Hitam (jika ada)
                if (localMoveHistory[i + 1]) {
                    const from = rowColToAlgebraic(localMoveHistory[i + 1].fromRow, localMoveHistory[i + 1].fromCol);
                    const to = rowColToAlgebraic(localMoveHistory[i + 1].toRow, localMoveHistory[i + 1].toCol);
                    const move = tempGame.move({ from, to, promotion: 'q' });

                    const blackMove = $(`<div class="move-notation">${move.san}</div>`);
                    blackMove.on('click', () => viewHistoryMove(i + 1));
                    movePair.append(blackMove);
                }

                historyList.append(movePair);
            }

            // Auto-scroll ke bagian bawah daftar
            historyList.scrollTop(historyList.prop("scrollHeight"));
        }

        // Variabel global baru untuk melacak posisi saat melihat riwayat
        let currentHistoryIndex = -1;

        // GANTI FUNGSI viewHistoryMove LAMA ANDA DENGAN INI
        function viewHistoryMove(moveIndex) {
            viewingHistory = true;
            currentHistoryIndex = moveIndex;
            historyBoard.reset();

            for (let i = 0; i <= moveIndex; i++) {
                const from = rowColToAlgebraic(localMoveHistory[i].fromRow, localMoveHistory[i].fromCol);
                const to = rowColToAlgebraic(localMoveHistory[i].toRow, localMoveHistory[i].toCol);
                historyBoard.move({ from, to, promotion: 'q' });
            }
            board.set(historyBoard.fen());
        }


        // GANTI FUNGSI LAMA DENGAN VERSI BARU INI
        function getMovesString() {
            let moves = '';
            // Iterasi melalui riwayat langkah lokal kita
            localMoveHistory.forEach(move => {
                // Ubah format koordinat baris/kolom kembali ke notasi catur (e.g., "e2e4")
                const from = rowColToAlgebraic(move.fromRow, move.fromCol);
                const to = rowColToAlgebraic(move.toRow, move.toCol);
                // Tambahkan ke string
                moves += ` ${from}${to}`;
            });
            console.log("Generated move string for Stockfish:", moves); // Log untuk debug
            return moves;
        }

        function updateClockPositions() {
            // Ambil elemen jam dari templat
            const whiteClock = $('#whiteClock');
            const blackClock = $('#blackClock');

            // Kosongkan wadah jam sebelum menambahkan lagi
            opponentClockContainer.empty();
            playerClockContainer.empty();

            // Tentukan posisi jam berdasarkan warna pemain
            if (playerColor === 'white') {
                opponentClockContainer.append(blackClock); // Jam lawan (Hitam) di atas
                playerClockContainer.append(whiteClock);   // Jam pemain (Putih) di bawah
            } else {
                opponentClockContainer.append(whiteClock);   // Jam lawan (Putih) di atas
                playerClockContainer.append(blackClock);  // Jam pemain (Hitam) di bawah
            }
        }

        // --- WebSocket Logic ---
        function connectToServer() {
            try {
                const wsHost = window.location.hostname;
                console.log(`Attempting to connect WebSocket to: ${wsHost}`); // Log untuk debugging
                socket = new WebSocket(`ws://${wsHost}:9001`);

                socket.onopen = () => {
                    setStatus('Connected to server. Create or join a game.');
                    setConnectionStatus('connected');
                    showSection('lobby');
                    createGameBtn.prop('disabled', false);

                    const storedGameId = localStorage.getItem('myGameId');
                    const storedPlayerColor = localStorage.getItem('playerColor');

                    if (storedGameId && storedPlayerColor) {
                        socket.send(JSON.stringify({
                            type: 'rejoinGame',
                            gameId: storedGameId,
                            playerColor: storedPlayerColor
                        }));
                        setStatus('Rejoining game...');
                    }
                };
                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data);
                    } catch (e) {
                        console.error('Error parsing message:', e);
                    }
                };
                socket.onclose = () => {
                    setStatus('Connection closed. Reconnecting...');
                    setConnectionStatus('disconnected');
                    gameActive = false;
                    updateButtonStates();
                    setTimeout(connectToServer, 3000);
                };
                socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    setStatus('Connection error.');
                    setConnectionStatus('disconnected');
                };
            } catch (e) {
                console.error('Failed to connect:', e);
                setStatus('Error connecting to server.');
            }
        }

        function handleServerMessage(data) {
            console.log('Received message from server:', data);
            switch (data.type) {
                case 'playerAssigned':
                    playerColor = data.color;
                    myGameId = data.gameId;
                    localStorage.setItem('myGameId', myGameId);
                    localStorage.setItem('playerColor', playerColor);
                    board.orientation(playerColor);
                    // ... setelah baris board.orientation(playerColor);
                    updateClockPositions();
                    setConnectionStatus('connected');
                    playerDisplayEl.html(`<span class="connection-status connected"></span>Player: ${capitalize(playerColor)} (Game: ${myGameId})`);
                    if (data.color === 'white') {
                        showSection('waitingRoom');
                        waitingMessageEl.text(`Game ${myGameId} has been created. Waiting for another player to join.`);
                    }
                    break;
                case 'lobbyUpdate':
                    const gameList = $('#gameList');
                    gameList.empty();
                    if (data.games && data.games.length > 0) {
                        data.games.forEach(gameId => {
                            const gameCard = $(`
                                        <div class="game-card">
                                            <div class="game-info">
                                                <span>Game ID: ${gameId}</span>
                                            </div>
                                            <button class="btn btn-success join-game-from-list">Join</button>
                                        </div>
                                    `);
                            gameCard.find('.join-game-from-list').on('click', () => {
                                socket.send(JSON.stringify({ type: 'joinGame', gameId: gameId }));
                            });
                            gameList.append(gameCard);
                        });
                    } else {
                        gameList.html('<p class="no-games-message">No games are currently available. Why not create one?</p>');
                    }
                    break;
                case 'gameStart':
                    localMoveHistory = []; // <-- Tambahkan baris ini
                    showSection('game');
                    showSection('game');
                    gameActive = true;
                    updateButtonStates();
                    setStatus('Game started! White to move.');


                    // PERBAIKAN: Gunakan flag isAiGame untuk inisialisasi AI
                    // Kondisi ini sekarang akan terpenuhi dengan benar.
                    if (isAiGame && !stockfish) {
                        initStockfish(selectedSkillLevel);
                    }
                    updateMoveHistory(); // <-- Panggil di sini
                    break;
                case 'gameEnded':
                    gameActive = false;
                    updateButtonStates();
                    stopClock();
                    let gameEndMessageText = '';
                    if (data.reason === 'resignation') {
                        gameEndMessageText = data.resignedPlayer === playerColor ? 'Anda kalah karena menyerah.' : 'Anda menang! Lawan menyerah.';
                    } else if (data.reason === 'disconnect') {
                        gameEndMessageText = data.disconnectedPlayer === playerColor ? 'Anda kalah karena terputus.' : 'Anda menang! Lawan terputus.';
                    } else {
                        const winnerText = data.winner === playerColor ? 'Anda menang!' : 'Anda kalah!';
                        gameEndMessageText = `Game Selesai: ${winnerText} dengan ${data.reason}.`;
                    }
                    gameOverMessage.text(gameEndMessageText);
                    localStorage.removeItem('playerColor');
                    localStorage.removeItem('myGameId');
                    gameUIContainer.css('display', 'none');
                    gameOverOverlay.css('display', 'flex');
                    // Hentikan worker Stockfish jika ada
                    if (stockfish) {
                        stockfish.terminate();
                        stockfish = null;
                        isAiGame = false;
                    }
                    break;
                case 'newGame':
                    localMoveHistory = []; // <-- Tambahkan baris ini juga
                    game.reset();
                    board.set(game.fen());
                    gameActive = true;
                    updateButtonStates();
                    setStatus("New game started! White's turn.");
                    break;
                case 'boardUpdate':
                    updateGameState(data.gameState);
                    if (data.lastMove) {
                        highlightLastMove(data.lastMove);
                        localMoveHistory.push(data.lastMove); // <-- TAMBAHKAN BARIS INI
                    }
                    updateMoveHistory(); // <-- Panggil di sini
                    if (isAiGame && gameActive && playerColor.charAt(0) !== game.turn()) {
                        setTimeout(askStockfishToMove, 500);
                    }
                    break;
                case 'rejoinSuccess':
                    playerColor = data.color;
                    myGameId = data.gameId;
                    board.orientation(playerColor);
                    // ... setelah baris board.orientation(playerColor);
                    updateClockPositions();
                    setConnectionStatus('connected');
                    playerDisplayEl.html(`<span class="connection-status connected"></span>Player: ${capitalize(playerColor)} (Game: ${myGameId})`);
                    showSection('game');
                    gameActive = true;
                    updateButtonStates();
                    setStatus('Successfully rejoined game.');
                    updateGameState(data.gameState);
                    updateMoveHistory(); // <-- Panggil di sini
                    break;
                case 'playerDisconnected':
                    gameActive = false;
                    updateButtonStates();
                    setStatus('Opponent disconnected. Waiting...');
                    showSection('waitingRoom');
                    waitingMessageEl.text('Your opponent has disconnected. Waiting for them to rejoin.');
                    break;
                case 'error':
                    setStatus('Error: ' + data.message);
                    board.set(game.fen(), false);
                    showSection('lobby');
                    break;
            }
        }

        // --- Game Logic & UI (Tidak ada perubahan di sini) ---
        function updateGameState(gameState) {
            const fen = serverBoardToFen(gameState.board, gameState.currentPlayer);
            game.load(fen);
            board.set(fen);
            gameActive = gameState.gameActive;
            updateButtonStates();
            whiteTimeRemaining = gameState.whiteTime;
            blackTimeRemaining = gameState.blackTime;
            lastUpdateTime = performance.now();
            if (gameActive && !game.game_over()) {
                startClock();
            } else {
                stopClock();
            }
            updateClockDisplay(whiteClockEl, whiteTimeRemaining);
            updateClockDisplay(blackClockEl, blackTimeRemaining);
            if (!gameActive) {
                setStatus("Game is over.");
                return;
            }
            const turn = game.turn() === 'w' ? 'White' : 'Black';
            const statusText = playerColor.charAt(0) === game.turn() ? "Your turn" : `Waiting for ${turn}`;
            setStatus(`${statusText} (${turn} to move)`);
        }

        function onDragStart(source, piece) {
            // Fungsi ini sekarang hanya berisi validasi dasar
            if (!gameActive || game.game_over() ||
                playerColor.charAt(0) !== game.turn() ||
                (game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        let clickSourceSquare = null;

        /**
         * FUNGSI BARU (BAGIAN 1)
         * Menangani semua hal SETELAH sebuah gerakan dianggap valid oleh chess.js.
         * Termasuk memperbarui papan, mengirim ke server, dan cek game over.
         */
        function handleValidMove(move) {
            // Perbarui papan visual dengan FEN yang benar dari chess.js
            board.set(game.fen());

            console.log(`Gerakan valid: ${move.from}-${move.to}. Mengirim ke server...`);

            // Kirim data gerakan ke server
            const moveData = {
                type: 'move',
                gameId: myGameId,
                ...algebraicToRowCol(move.from),
                ...algebraicToRowCol(move.to, true)
            };
            socket.send(JSON.stringify(moveData));

        }


        /**
         * FUNGSI BARU (BAGIAN 2)
         * Menggantikan attemptMove yang lama. Fungsi ini sekarang bisa mendeteksi promosi.
         */
        function attemptMove(from, to) {
            const piece = game.get(from); // Dapatkan info bidak yang digerakkan

            // DETEKSI PROMOSI: Cek apakah ini gerakan pion ke baris terakhir
            if (piece && piece.type === 'p' &&
                ((piece.color === 'w' && from.charAt(1) === '7' && to.charAt(1) === '8') ||
                    (piece.color === 'b' && from.charAt(1) === '2' && to.charAt(1) === '1'))) {
                // Ini adalah langkah promosi. Simpan langkahnya dan tampilkan dialog.
                pendingMove = { from: from, to: to };

                // Sesuaikan warna bidak di dialog promosi
                const color = game.turn();
                $('#promotionDialog .promotion-piece img').each(function () {
                    const pieceType = $(this).parent().data('piece').toUpperCase();
                    $(this).attr('src', `img/chesspieces/wikipedia/${color}${pieceType}.png`);
                });

                $('#promotionOverlay').css('display', 'flex');
                return; // Hentikan proses, tunggu input pengguna
            }

            // Jika BUKAN promosi, lanjutkan seperti biasa
            const move = game.move({ from: from, to: to });

            removeHighlights();
            clickSourceSquare = null;

            if (move === null) {
                board.set(game.fen());
                return 'snapback';
            }

            // Jika gerakan valid, panggil handler yang baru kita buat
            handleValidMove(move);
        }
        /**
* Handler untuk event drop.
* - Jika source === target, ini dianggap "klik pertama" untuk mode klik-ke-klik.
* - Jika source !== target, ini dianggap sebagai gerakan drag-and-drop biasa.
*/
        // GANTI FUNGSI onDrop ANDA DENGAN VERSI INI

        function onDrop(source, target) {
            // JALUR 1: Ini adalah "klik pertama" (tidak berubah)
            if (source === target) {
                if (clickSourceSquare !== null) {
                    removeHighlights();
                    clickSourceSquare = null;
                    return;
                }

                const pieceOnSquare = game.get(source);
                const turn = game.turn();
                if (pieceOnSquare && pieceOnSquare.color === turn) {
                    clickSourceSquare = source;
                    highlightSquare(source);
                }

                return 'snapback';
            }

            // JALUR 2: Ini adalah gerakan drag-and-drop
            // <-- PERUBAHAN: Tambahkan 'return' di sini
            return attemptMove(source, target);
        }
        /**
        * Handler untuk klik di kotak mana pun.
        * Fungsi ini hanya akan melakukan sesuatu jika "klik pertama" sudah terjadi
        * (yaitu, clickSourceSquare sudah terisi).
        */
        function onSquareClick(square) {
            // Jika belum ada bidak yang dipilih (ini bukan klik kedua), abaikan.
            if (clickSourceSquare === null) {
                return;
            }

            // Jika klik kedua dilakukan di kotak yang sama dengan yang pertama, batalkan.
            if (square === clickSourceSquare) {
                removeHighlights();
                clickSourceSquare = null;
                return;
            }

            // Jika ini adalah klik kedua, panggil fungsi attemptMove
            attemptMove(clickSourceSquare, square);
        }


        function onSnapEnd() {
            if (selectedSquare) {
                $('#myBoard .square-' + selectedSquare).removeClass('highlight-square');
                selectedSquare = null;
            }
            board.set(game.fen());
        }

        // Fungsi bantuan untuk highlight (opsional tapi sangat membantu)
        function highlightSquare(square) {
            // Anda bisa menggunakan jQuery atau JS murni untuk menambahkan class CSS
            document.querySelector(`.square-${square}`).classList.add('highlight');
        }

        function removeHighlights() {
            document.querySelectorAll('.square-55d63').forEach(el => {
                el.classList.remove('highlight');
            });
        }
        function highlightLastMove(lastMove) {
            $('#myBoard .square-55d63').css('background-color', '');
            const fromSquare = rowColToAlgebraic(lastMove.fromRow, lastMove.fromCol);
            const toSquare = rowColToAlgebraic(lastMove.toRow, lastMove.toCol);
            $('#myBoard .square-' + fromSquare).css('background', '#ffb347');
            $('#myBoard .square-' + toSquare).css('background', '#ffb347');
        }

        // --- Helper Functions (Tidak ada perubahan di sini) ---
        function serverBoardToFen(boardData, currentPlayer) {
            let fen = boardData.map(row => {
                let empty = 0, rowFen = '';
                row.forEach(piece => {
                    if (piece === '') empty++;
                    else { if (empty > 0) { rowFen += empty; empty = 0; } rowFen += piece; }
                });
                if (empty > 0) rowFen += empty;
                return rowFen;
            }).join('/');
            fen += ` ${currentPlayer === 'white' ? 'w' : 'b'} KQkq - 0 1`;
            return fen;
        }
        function algebraicToRowCol(alg, isTarget = false) {
            const col = alg.charCodeAt(0) - 'a'.charCodeAt(0);
            const row = 8 - parseInt(alg.charAt(1), 10);
            return isTarget ? { toRow: row, toCol: col } : { fromRow: row, fromCol: col };
        }
        function rowColToAlgebraic(row, col) {
            return String.fromCharCode('a'.charCodeAt(0) + col) + (8 - row);
        }
        function setStatus(message) { statusEl.text(message); }
        function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
        function setConnectionStatus(status) { connectionIndicator.removeClass('connected waiting disconnected').addClass(status); }
        function updateButtonStates() {
            resignBtn.prop('disabled', !gameActive);
            newGameBtn.prop('disabled', false);
        }

        // --- Clock Management (Tidak ada perubahan di sini) ---
        function startClock() { if (!clockInterval) clockInterval = setInterval(updateClock, 100); }
        function stopClock() { if (clockInterval) { clearInterval(clockInterval); clockInterval = null; } }
        function updateClock() {
            if (!gameActive) return stopClock();
            const elapsedMs = performance.now() - lastUpdateTime;
            lastUpdateTime = performance.now();
            if (game.turn() === 'w') whiteTimeRemaining -= elapsedMs;
            else blackTimeRemaining -= elapsedMs;
            if (whiteTimeRemaining < 0) whiteTimeRemaining = 0;
            if (blackTimeRemaining < 0) blackTimeRemaining = 0;
            updateClockDisplay(whiteClockEl, whiteTimeRemaining);
            updateClockDisplay(blackClockEl, blackTimeRemaining);
        }
        function formatTime(ms) {
            const s = ms / 1000;
            if (s < 60) return `${Math.floor(s)}.${Math.floor((ms % 1000) / 100)}`;
            return `${Math.floor(s / 60).toString().padStart(2, '0')}:${Math.floor(s % 60).toString().padStart(2, '0')}`;
        }
        function updateClockDisplay(el, ms) {
            el.text(el.attr('id').includes('white') ? `White: ${formatTime(ms)}` : `Black: ${formatTime(ms)}`);
        }

        // --- Event Handlers (Ini bagian yang diperbarui) ---

        // GANTI SEMUA EVENT HANDLER TOMBOL RIWAYAT ANDA DENGAN INI
        $('#rewindBtn').on('click', () => {
            viewHistoryMove(-1); // -1 akan menampilkan posisi awal (papan kosong)
        });

        $('#prevBtn').on('click', () => {
            if (currentHistoryIndex >= 0) {
                viewHistoryMove(currentHistoryIndex - 1);
            }
        });

        $('#nextBtn').on('click', () => {
            if (currentHistoryIndex < localMoveHistory.length - 1) {
                viewHistoryMove(currentHistoryIndex + 1);
            }
        });

        $('#fastForwardBtn').on('click', () => {
            viewingHistory = false;
            currentHistoryIndex = localMoveHistory.length - 1;
            board.set(game.fen()); // Kembali ke posisi live
        });

        createGameBtn.on('click', () => {
            const selectedTime = timeFormatSelect.val();
            socket.send(JSON.stringify({ type: 'createGame', timeFormat: parseInt(selectedTime) }));
        });

        // Handler untuk tombol Join DENGAN ID
        joinGameBtn.on('click', () => {
            const gameId = joinGameIdInput.val();
            if (gameId) socket.send(JSON.stringify({ type: 'joinGame', gameId: gameId }));
        });

        // Mengaktifkan/menonaktifkan tombol join DENGAN ID saat input diisi
        joinGameIdInput.on('input', () => {
            joinGameBtn.prop('disabled', !joinGameIdInput.val());
        });

        resignBtn.on('click', () => {
            if (confirm('Are you sure you want to resign?')) {
                socket.send(JSON.stringify({ type: 'resign', gameId: myGameId }));
            }
        });

        newGameBtn.on('click', () => {
            socket.send(JSON.stringify({ type: 'newGame', gameId: myGameId }));
        });

        clearLocalStorageBtn.on('click', () => {
            localStorage.removeItem('myGameId');
            localStorage.removeItem('playerColor');
            alert('Local storage cleared! Page will now reload.');
            location.reload();
        });

        backToLobbyBtn.on('click', () => {
            gameOverOverlay.css('display', 'none');
            showSection('lobby');
        });

        playAiBtn.on('click', () => {
            isAiGame = true;

            const selectedTime = $('#timeFormat').val();
            selectedSkillLevel = $('#skillLevel').val(); // <-- Ambil nilai skill level
            socket.send(JSON.stringify({ type: 'createAiGame', timeFormat: parseInt(selectedTime) }));
            initStockfish(selectedSkillLevel);
        });

        $('#myBoard').on('click', '.square-55d63', function () { const square = $(this).data('square'); onSquareClick(square) });
        // --- Initialization ---

        const config = { draggable: true, position: 'start', pieceTheme: 'img/chesspieces/wikipedia/{piece}.png', onDragStart: onDragStart, onDrop: onDrop, onSquareClick: onSquareClick };
        const boardElement = document.getElementById('myBoard');
        board = Chessground(boardElement, config);

        // Tambahkan event listener dengan opsi { passive: false }
        boardElement.addEventListener('touchmove', function (e) {
            e.preventDefault();
        }, { passive: false });
        //
        // Event listener untuk tombol-tombol di dialog promosi
        $('.promotion-piece').on('click', function () {
            if (!pendingMove) return;

            const promotionPiece = $(this).data('piece');

            // Lakukan gerakan dengan properti promosi
            const move = game.move({
                from: pendingMove.from,
                to: pendingMove.to,
                promotion: promotionPiece
            });
            console.log(`promotionPiece: ${promotionPiece}`);

            // Sembunyikan dialog
            $('#promotionOverlay').css('display', 'none');
            pendingMove = null; // Bersihkan langkah yang tertunda

            // Jika gerakan promosi valid (seharusnya selalu valid), panggil handler
            if (move) {
                handleValidMove(move);
            }
        });

        $(window).resize(board.resize);
        connectToServer();
    </script>
</body>
</html>